/**
 * Server Module.
 * V0.1-181016
 *
 * Last Updates:
 * - setServerRoot added.
 */

var colors, express, fs, pug, pathmodule, bodyParser;
const logger = require('./Noty.js');
var noty = new logger.Noty("done");

/**
 * Constructor.
 * @param install_modules
 * @constructor
 */
function ServerBox(install_modules) {
    colors = require('colors/safe');
    express = require('express');
    fs = require('fs');
    pug = require('pug');
    pathmodule = require('path');
    bodyParser = require('body-parser');


    noty.log(colors.cyan.bold('Starting WebBox.', 'done'));

    this.app = express();
    this.app.use(bodyParser.urlencoded({extended: true}));
    this.app.use(bodyParser.json());                        // Include Express
    this.port = 80;                                         // Default listening port
    this.path = pathmodule.dirname(require.main.filename);  // Get project path
    this.module_path_abs = __dirname; // Get module path
    this.module_path = "/node_modules/webbox/";
}

/**
 * Starts web-server on port = <srv_port>
 * @param srv_port
 */
ServerBox.prototype.createServer = function(srv_port) {
    this.port = srv_port;

    // Start listening port
    this.app.listen(this.port);
    noty.log('Server listening on port *:' + this.port, 'done');
};

/**
 * DEPRECATED METHOD!
 *
 * Makes a directory as recource.
 * @param dir
 */
ServerBox.prototype.newResourceFolder = function (dir) {
    var abs_path = this.path + '/';
    this.app.get(dir+':name', function (req, res, next) {
        var pth = abs_path + dir + req.params.name;
        res.sendFile(pth);
    });
    noty.log('New resource folder: ' + dir);
};

/* YOUR FUNCTION
ServerBox.prototype.setServerRoot = function (path) {
    var server_root = this.path+path;
    noty.log(server_root);
    this.app.get(/(.+?)(\.[^.]*$|$)/, function(req,res)
    {
        res.sendFile((server_root+decodeURI(req._parsedUrl.pathname)), function(err)
        {
            if (err) {
                res.status(404).send('Sorry, cant find that!');
                noty.log('[404]Error while trying to find an object.', 'err');
            }
            else {
                noty.log('Object was sent:', 'info');
            }
        });
    })
};
*/

/**
 * Makes directory as root of the server.
 * @param dir: Path to directory, which will be the root of the server
 */

ServerBox.prototype.setServerRoot = function(dir){
    var fileAbsPath = pathmodule.join(this.path, dir);

    // Chek for existing index.html file
    var checkIndex = ServerBox.fileExists(fileAbsPath, 'index.html');
    if (checkIndex.fileExists) {
        var indexPath = pathmodule.join(fileAbsPath, 'index.html');
        this.app.get('/', function (req, res){
            res.sendFile(indexPath);
        });
    } else {
        this.app.get('/', function (req, res){
            res.sendStatus(404);
        });
    }

    // Set all folders as resources (Recource method)
    var regex = /(.+?)(\.[^.]*$|$)/;
    this.app.get(regex, function (req, res) {
        // console.log(req._parsedUrl.pathname); Get path name
        // console.log(req.query); GET Query Params
        var pathname = decodeURI(req._parsedUrl.pathname);
        var checkFile = ServerBox.fileExists(fileAbsPath, pathname);
        if (checkFile.fileExists) {
            res.status(checkFile.status).sendFile(pathmodule.join(fileAbsPath, pathname));
        } else {
            res.sendStatus(checkFile.status);
        }
    });
}

/**
 * Check file existing.
 * - If file not found, it returns object with fileExists = false, status = 404.
 * - If file is a directory, fileExists = false, status = 403 (Forbidden)
 * - If file was found, fileExists = true, status = 200
 * @param path
 * @param filename
 * @returns {{fileExists: boolean, status: number}}
 */

ServerBox.fileExists = function (path, filename) {
    path = pathmodule.join(path, filename);
    var result = {
        fileExists: false,
        status: 404
    }
    try {
        var stats = fs.statSync(path);
        if (stats !== undefined) {
            if (stats.isFile()){
                noty.log('GET: ' + path + ' FOUND');
                result.fileExists = true;
                result.status = 200;
            } else if (stats.isDirectory()) {
                noty.log('GET: ' + path + ' RESTRICT DIRECTORY');
                result.fileExists = false;
                result.status = 403;
            } else {
                noty.log('GET: ' + path + ' NOT FOUND', 'err');
                result.fileExists = false;
                result.status = 404;
            }
        } else {
            noty.log('GET: ' + path + ' NOT FOUND', 'err');
            result.fileExists = false;
            result.status = 404;
        }
    } catch (err) {
        //console.log(err);
    }
    if (!result.fileExists)
        noty.log('GET: ' + path + " ERROR", 'warn');
    return result;
}

/**
 * Makes all files in dir as downloadable.
 * @param dir
 */
ServerBox.prototype.newDownloadFolder = function (dir) {
    var abs_path = this.path + '/';
    this.app.get(dir+':name', function (req, res, next) {
        var pth = abs_path + dir + req.params.name;
        res.sendFile(pth);
    });
    noty.log('New download folder: ' + dir, 'done');
}

/**
 * Creates a new GET/POST request listener with user-function.
 * @param req_path
 * @param method
 * @param callback
 */
ServerBox.prototype.newRequestListener = function(req_path, method, callback) {
    if (method.toLowerCase() == "get") {
        this.app.get(req_path, function(req,res) {
            callback(req, res);
        });
    }
    else if (method.toLowerCase() == "post") {
        this.app.post(req_path, function(req,res) {
            callback(req, res);
        });
    }
}

/**
 * Creates a new request listener with static page.
 * @param req_path
 * @param page_path
 */
ServerBox.prototype.newStaticPage = function (req_path, page_path) {
    var abs_path = this.path + '/';

    this.app.get(req_path, function (req, res, next) {
        var pth = abs_path + page_path;
        res.sendFile(pth);
    });
    noty.log('New static page: ' + page_path, 'done');
}

/**
 * Send response as JSON-object.
 * @param res
 * @param json_obj
 */
ServerBox.prototype.sendJSON = function (res, json_obj) {
    res.json(json_obj);
}

/**
 * Redirect user to <path>.
 * @param res
 * @param path
 */
ServerBox.prototype.redirectLink = function(res, path) {
    res.redirect(path);
}

exports.ServerBox=ServerBox;